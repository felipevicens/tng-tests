---
author: "Aureliano Sinatra (EGM)"
description: "Performance test for mqtt broker"
descriptor_schema: https://raw.githubusercontent.com/sonata-nfv/tng-schema/master/test-descriptor/testdescriptor-schema.yml
name: "test-industrial-pilot-ns1-low-data-rate"
vendor: "eu.5gtango.egm"
version: '0.2'

service_platforms:
  - "SONATA"
test_category:
  - "benchmarking"
testing_tags:
  - "IPreq013-lowdr"

phases:
  - id: setup
    steps:
    - action: deploy
      description: "Deploying a NS"
      name: deployment
    - action: configure
      description: "Configuration"
      name: configuration
      probes:
      - id: mqttconstant
        description: "A service initial configuration container"
        image: "easyglobalmarket/mqtt-constant"
        name: mqttconstant
        parameters:
        - key: IP
          value: '$(smpilot-cc/endpoints/id:floating_ip/address)'
        - key: PORT
          value: '$(smpilot-cc/endpoints/id:floating_ip/ports/id:mqtt/port)'
        - key: CLIENTS
          value: '100'
        - key: COUNT
          value: '1'
        - key: SIZE
          value: '125' 
        - key: ROUNDS
          value: '100'
        - key: QOS
          value: '2' 
        - key: INTERVAL
          value: '20'
      - id: subscriber
        description: "A service initial configuration container"
        image: "easyglobalmarket/mqtt-sub"
        name: subscriber
        parameters:
        - key: IP
          value: '$(smpilot-cc/endpoints/id:floating_ip/address)'
        - key: PORT
          value: '$(smpilot-cc/endpoints/id:floating_ip/ports/id:mqtt/port)'
        - key: INTERVAL
          value: '20'
        - key: TOPIC
          value: 'WIMMS1/EM63/DATE'
      - id: publisher
        description: "A service initial configuration container"
        image: "easyglobalmarket/mqtt-pub"
        name: publisher
        parameters:
        - key: IP
          value: '$(smpilot-cc/endpoints/id:floating_ip/address)'
        - key: PORT
          value: '$(smpilot-cc/endpoints/id:floating_ip/ports/id:mqtt/port)'
        - key: INTERVAL
          value: '20'
        - key: ROUNDS
          value: '10'
        - key: TOPIC
          value: 'WIMMS1/EM63/DATE'
        - key: CLIENTS
          value: '1'
        - key: COUNT
          value: '1'            
  - id: exercise
    steps:
    - command: /bin/sh
      dependencies: []
      description: "Starting the mqtt probe"
      entrypoint: /app/entrypoint.sh
      index: 2
      instances: 1
      name: mqttconstant
      output:
      - {results: logs.txt}
      run: mqttconstant
    - command: /bin/sh
      dependencies: []
      description: "Starting the mqtt subscriber"
      entrypoint: /mqtt-pubsub/entrypoint.sh
      index: 1
      instances: 1
      name: subscriber
      output:
      - {results: logs.txt}
      run: subscriber
    - command: /bin/sh
      dependencies: []
      description: "Starting the mqtt publisher"
      entrypoint: /mqtt-pubsub/entrypoint.sh
      index: 2
      instances: 1
      name: publisher
      output:
      - {results: logs.txt}
      run: publisher    
  - id: verification
    steps:
    - step: mqttconstant
      description: "Check obtained results"
      name: mqttconstant
      conditions:
          - condition: present
            file: results.out
            find: '"failures": 0'
            name: no-error
            verdict: pass
    - step: subscriber
      description: "Check obtained results"
      name: subscriber
      conditions:
          - condition: present
            file: results.out
            find: 'Latency'
            name: subscription-received
            verdict: pass        
